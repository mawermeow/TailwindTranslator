(()=>{"use strict";Symbol();const e=Symbol();const t=Object.getPrototypeOf,o=new WeakMap,n=e=>e&&(o.has(e)?o.get(e):t(e)===Object.prototype||t(e)===Array.prototype),r=(e,t=!0)=>{o.set(e,t)},s=e=>"object"==typeof e&&null!==e,l=new WeakMap,c=new WeakSet,a=(t=Object.is,o=((e,t)=>new Proxy(e,t)),a=(e=>s(e)&&!c.has(e)&&(Array.isArray(e)||!(Symbol.iterator in e))&&!(e instanceof WeakMap)&&!(e instanceof WeakSet)&&!(e instanceof Error)&&!(e instanceof Number)&&!(e instanceof Date)&&!(e instanceof String)&&!(e instanceof RegExp)&&!(e instanceof ArrayBuffer)),i=(e=>{switch(e.status){case"fulfilled":return e.value;case"rejected":throw e.reason;default:throw e}}),d=new WeakMap,p=((e,t,o=i)=>{const n=d.get(e);if((null==n?void 0:n[0])===t)return n[1];const s=Array.isArray(e)?[]:Object.create(Object.getPrototypeOf(e));return r(s,!0),d.set(e,[t,s]),Reflect.ownKeys(e).forEach((t=>{if(Object.getOwnPropertyDescriptor(s,t))return;const n=Reflect.get(e,t),a={value:n,enumerable:!0,configurable:!0};if(c.has(n))r(n,!1);else if(n instanceof Promise)delete a.value,a.get=()=>o(n);else if(l.has(n)){const[e,t]=l.get(n);a.value=p(e,t(),o)}Object.defineProperty(s,t,a)})),s}),u=new WeakMap,g=[1,1],f=(r=>{if(!s(r))throw new Error("object required");const i=u.get(r);if(i)return i;let d=g[0];const h=new Set,w=(e,t=++g[0])=>{d!==t&&(d=t,h.forEach((o=>o(e,t))))};let v=g[1];const m=e=>(t,o)=>{const n=[...t];n[1]=[e,...n[1]],w(n,o)},y=new Map,b=e=>{var t;const o=y.get(e);o&&(y.delete(e),null==(t=o[1])||t.call(o))},k=Array.isArray(r)?[]:Object.create(Object.getPrototypeOf(r)),E={deleteProperty(e,t){const o=Reflect.get(e,t);b(t);const n=Reflect.deleteProperty(e,t);return n&&w(["delete",[t],o]),n},set(o,r,i,d){const p=Reflect.has(o,r),g=Reflect.get(o,r,d);if(p&&(t(g,i)||u.has(i)&&t(g,u.get(i))))return!0;b(r),s(i)&&(i=(t=>n(t)&&t[e]||null)(i)||i);let v=i;if(i instanceof Promise)i.then((e=>{i.status="fulfilled",i.value=e,w(["resolve",[r],e])})).catch((e=>{i.status="rejected",i.reason=e,w(["reject",[r],e])}));else{!l.has(i)&&a(i)&&(v=f(i));const e=!c.has(v)&&l.get(v);e&&((e,t)=>{if(y.has(e))throw new Error("prop listener already exists");if(h.size){const o=t[3](m(e));y.set(e,[t,o])}else y.set(e,[t])})(r,e)}return Reflect.set(o,r,v,d),w(["set",[r],i,g]),!0}},S=o(k,E);u.set(r,S);const j=[k,(e=++g[1])=>(v===e||h.size||(v=e,y.forEach((([t])=>{const o=t[1](e);o>d&&(d=o)}))),d),p,e=>{h.add(e),1===h.size&&y.forEach((([e,t],o)=>{if(t)throw new Error("remove already exists");const n=e[3](m(o));y.set(o,[e,n])}));return()=>{h.delete(e),0===h.size&&y.forEach((([e,t],o)=>{t&&(t(),y.set(o,[e]))}))}}];return l.set(S,j),Reflect.ownKeys(r).forEach((e=>{const t=Object.getOwnPropertyDescriptor(r,e);"value"in t&&(S[e]=r[e],delete t.value,delete t.writable),Object.defineProperty(k,e,t)})),S}))=>[f,l,c,t,o,a,i,d,p,u,g],[i]=a();function d(e={}){return i(e)}function p(e){const t=l.get(e);return null==t?void 0:t[1]()}function u(e,t,o){const n=l.get(e);let r;n||console.warn("Please use proxy object");const s=[],c=n[3];let a=!1;const i=c((e=>{s.push(e),o?t(s.splice(0)):r||(r=Promise.resolve().then((()=>{r=void 0,a&&t(s.splice(0))})))}));return a=!0,()=>{a=!1,i()}}Symbol();const g=new WeakMap,f=new WeakMap,h=(e,t)=>{const o=g.get(e);o&&(o[0].forEach((t=>{const{d:o}=t;e!==o&&h(o)})),++o[2],t&&o[3].add(t))},w=(e,t)=>{const o=g.get(e);return!!(null==o?void 0:o[2])&&(o[3].add(t),!0)},v=e=>{const t=g.get(e);t&&(--t[2],t[2]||(t[3].forEach((e=>e())),t[3].clear()),t[0].forEach((t=>{const{d:o}=t;e!==o&&v(o)})))},m=e=>{const{s:t,d:o}=e;let n=f.get(o);n||(n=[new Set],f.set(e.d,n)),n[0].add(e);let r=g.get(t);if(!r){const e=new Set,o=u(t,(o=>{e.forEach((e=>{const{d:n,c:r,n:s,i:l}=e;t===n&&o.every((e=>1===e[1].length&&l.includes(e[1][0])))||e.p||(h(t,r),s?v(t):e.p=Promise.resolve().then((()=>{delete e.p,v(t)})))}))}),!0);r=[e,o,0,new Set],g.set(t,r)}r[0].add(e)},y=e=>{const{s:t,d:o}=e,n=f.get(o);null==n||n[0].delete(e),0===(null==n?void 0:n[0].size)&&f.delete(o);const r=g.get(t);if(r){const[o,n]=r;o.delete(e),o.size||(n(),g.delete(t))}};function b(e,t){const o=(null==t?void 0:t.proxy)||d({}),n=!!(null==t?void 0:t.sync),r=Object.keys(e);return r.forEach((t=>{if(Object.getOwnPropertyDescriptor(o,t))throw new Error("object property already defined");const s=e[t];let l=null;const c=()=>{if(l){if(Array.from(l).map((([e])=>w(e,c))).some((e=>e)))return;if(Array.from(l).every((([e,t])=>p(e)===t.v)))return}const e=new Map,a=s((t=>(e.set(t,{v:p(t)}),t))),i=()=>{e.forEach(((e,s)=>{var a;const i=null==(a=null==l?void 0:l.get(s))?void 0:a.s;if(i)e.s=i;else{const l={s,d:o,k:t,c,n,i:r};m(l),e.s=l}})),null==l||l.forEach(((t,o)=>{!e.has(o)&&t.s&&y(t.s)})),l=e};a instanceof Promise?a.finally(i):i(),o[t]=a};c()})),o}const k=e=>{if(e.includes(":")){const t=e.split(":");return{eventModule:t[0],eventTitle:t[1]}}return{eventModule:void 0,eventTitle:e}},E=(e,t)=>{const o=d(t),n=e=>u(o,e);if("event"===e){let t=[];const r=e=>n((()=>{e({vLookAt:o.vLookAt,hLookAt:o.hLookAt,fov:o.fov})})),s=[];let l=!1,c=!0;const a=()=>{if(l||0===s.length||!c)return;l=!0,c=!1;const e=s.shift();o.eventText=e};return(e=>n((()=>{if("string"==typeof o.eventText&&0!==o.eventText.length)if(o.eventText.includes(";"))for(const n of(t=o.eventText).includes(";")?t.split(";"):[t]){const{eventModule:t,eventTitle:o}=k(n);t&&e(t,o,void 0)}else{const{eventModule:t,eventTitle:n}=k(o.eventText);e(t,n,void 0)}var t;o.scene!==o.recordScene&&(e(void 0,void 0,o.scene),o.recordScene=o.scene)})))(((e,n,r)=>{t.forEach((t=>{t(e,n,r)})),o.eventText="",c=!0,l=!1,a()})),window.frontEnd={...window.frontEnd,[`${e}State`]:o,[`${e}Subscribe`]:e=>t.push(e),[`${e}MiddleWare`]:t,miniMapSubscribe:r},window.onEvent=e=>{"string"==typeof e&&e.length>0&&(s.push(e),a())},o}return window.frontEnd={...window.frontEnd,[`${e}State`]:o,[`${e}Subscribe`]:n},o};const S=()=>{if(document.getElementById("krpanoSWFObject")){const e=document.getElementById("krpanoSWFObject").get("global"),t=e=>{document.getElementById("krpanoSWFObject").get("global").get("xml.scene")!==e&&document.getElementById("krpanoSWFObject").get("global").call("mainloadscene("+e+");")},o=e=>{document.getElementById("krpanoSWFObject").get("global").call("looktohotspot("+e+");")},n=(e=null,t=null,o=null,n=2)=>{const r=document.getElementById("krpanoSWFObject").get("global").get("view"),s=null!==e?parseFloat(e):r.vlookat,l=null!==t?parseFloat(t):r.hlookat,c=null!==o?o:r.fov,a=parseFloat(r.hlookat),i=a+function(e,t){let o=(t-e)%360;return o>180&&(o-=360),o<-180&&(o+=360),o}(a,l);document.getElementById("krpanoSWFObject").get("global").call(`tween(view.vlookat,${s},${n});tween(view.hlookat,${i},${n});tween(view.fov,${c},${n});`)},r=(e,t)=>{document.getElementById("krpanoSWFObject").get("global")[e].getArray().forEach((e=>{t?t(e):console.log(e)}))},s=e=>{r("hotspot",e)},l=e=>{r("layer",e)},c=(e,t)=>{e.onclick&&(e.onclick_backup&&"string"!=typeof e.onclick||(e.onclick_backup=e.onclick,e.onclick=()=>{document.getElementById("krpanoSWFObject").get("global").call(e.onclick_backup),t(e.onclick_backup)}))},a=(e,t)=>{const o=document.getElementById("krpanoSWFObject").get("global").get(`hotspot[${e}]`),n=document.getElementById("krpanoSWFObject").get("global").get(`hotspot[${t}]`);o&&n&&"ath atv rx ry rz width height".split(" ").forEach((e=>{o[e]=n[e]}))},i=e=>{const t=document.getElementById("krpanoSWFObject").get("global");e.includes("video")?t.get("action[showpanovideospots]").content=t.get("action[showpanovideospots]").content.replace(`set(hotspot[${e}].visible, true);`,`set(hotspot[${e}].visible, false);`):e.includes("polygon")?t.get("action[showpanopolygonalspots]").content=t.get("action[showpanopolygonalspots]").content.replace(`set(hotspot[${e}].visible, true);`,`set(hotspot[${e}].visible, false);`):t.get("action[showpanopointspots]").content=t.get("action[showpanopointspots]").content.replace(`set(hotspot[${e}].visible, true);`,`set(hotspot[${e}].visible, false);`),t.get(`hotspot[${e}]`).visible=!1,t.get(`hotspot[${e}]`).muted=!0},d=(e,t,o)=>{const n=document.getElementById("krpanoSWFObject").get("global"),r=n.get(e).alpha,s=1e3*o;let l=null;const c=o=>{l||(l=o);const a=o-l,i=Math.min(a/s,1),d=r+(t-r)*i;n.get(e).alpha=d,i<1&&requestAnimationFrame(c)};requestAnimationFrame(c)},p=()=>{const e=document.getElementById("krpanoSWFObject").get("global").events.createItem("showNameEvent");e.keep=!0,e.onnewscene="jscall(window.krHelper.showName());"},u=(e=!1)=>{window.krHelper.allHotspot((t=>{const o=`jscall(console.log('${t.name} ${t.onclick}'));`;"string"==typeof t.onclick&&(e?t.onclick=o:t.onclick+=`();${o}`)})),window.krHelper.allLayer((t=>{const o=`jscall(console.log('${t.name} ${t.onclick}'));`;"string"==typeof t.onclick&&(e?t.onclick=o:t.onclick+=`();${o}`)}))};return window.krHelper={...window.krHelper,krObj:e,goScene:t,goHotspot:o,allHotspot:s,allLayer:l,appendClick:c,replaceVideoSpotPosition:a,hideSpot:i,updateAlpha:d,showName:u,goLookAt:n,showNameEvent:p},E("event",{eventText:"",vLookAt:`${e.get("view.vlookat")}`,hLookAt:`${e.get("view.hlookat")}`,fov:`${e.get("view.fov")}`,scene:`${e.get("xml.scene")}`,recordScene:""})}return window.krHelper=null,E("event",{eventText:"",vLookAt:"",hLookAt:"",fov:"",scene:"",recordScene:""})},j=e=>new Promise(((t,o)=>{let n=document.createElement("link");n.rel="stylesheet",n.href=e,n.onload=t,n.onerror=o,document.head.appendChild(n)})),$=(e,t=(()=>{}))=>{const o=document.createElement("script");o.src=e,o.onload=()=>{t&&"function"==typeof t&&t()},document.body.appendChild(o)},O=(e,t=(()=>{}))=>{const o=document.createElement("script");o.defer=!0,o.src=e,o.onload=()=>{t&&"function"==typeof t&&t()},document.body.appendChild(o)};let P="data:application/javascript;base64,"+btoa("\nself.addEventListener('message', (e) => {\n  if(e.data==='hello'){\n    self.postMessage('hello');\n  }\n  debugger;\n  self.postMessage('');\n});\n");const W=e=>{let t=setInterval((()=>{new Promise((e=>{let t=!1,o=new Worker(P);o.onmessage=n=>{"hello"===n.data?setTimeout((()=>{t||(e(!0),o.terminate())}),1):(t=!0,e(!1),o.terminate())},o.postMessage("hello")})).then((o=>{o&&(e(),clearInterval(t))}))}),1e3);return()=>clearInterval(t)};let A;const M=()=>{const e=(()=>{const e=new Date;return`${e.getFullYear().toString().slice(2)}${(e.getMonth()+1).toString().padStart(2,"0")}${e.getDate().toString().padStart(2,"0")}`})();return x+e};let x="";let F;const I=()=>{"function"==typeof F&&F(),F=window.noGuardian?()=>{}:W((()=>{document.body.innerHTML="",document.head.innerHTML="",delete window.frontEnd,delete window.backEnd,delete window.guardian})),((e,t=(()=>{}))=>{const o=e.toUpperCase().split("");let n=0;A&&document.removeEventListener("keydown",A),A=e=>{e.key.toUpperCase()===o[n]?(n++,n===o.length&&(console.log("input correct!"),t(),n=0)):n=0},document.addEventListener("keydown",A)})(M(),(()=>{alert("Stop guarding!"),F()}))};window.valtio={proxy:d,subscribe:u,snapshot:function(e,t){const o=l.get(e);o||console.warn("Please use proxy object");const[n,r,s]=o;return s(n,r(),t)},derive:b},window.frontEnd={...window.frontEnd,utils:{initState:E,addCss:j,addScript:$,addDeferScript:O,addPlugin:(e=[{name:"",serverHost:null,configSrc:null}])=>{const t=e=>{"http:"===location.protocol?$(`${e.serverHost}/static/js/bundle.js`):(j(`./frontEnd/plugin/${e.name}/static/css/main.css`),O(`./frontEnd/plugin/${e.name}/static/js/main.js`))};e.forEach((e=>{e.disable||(e.configSrc?$(e.configSrc,(()=>{t(e)})):t(e))}))},initKrState:S,getParam:(e,t=null)=>(e=>new URLSearchParams(window.location.search).has(e))(e)?(()=>{const e=new URLSearchParams(window.location.search),t={};for(const[o,n]of e)t[o]=n;return t})()[e]:t}},window.delay=e=>new Promise((t=>setTimeout(t,e))),window.guardian={key:e=>"string"==typeof e?(x=e,"updated!"):"type error, you should input a string for the key!",start:I},S(),I()})();